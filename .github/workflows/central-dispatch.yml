name: Central Dispatcher

on:
  workflow_call:
    inputs:
      event_name:
        type: string
      ref:
        type: string
      head_ref:
        type: string
      comment_body:
        type: string

jobs:
  handle-event:
    runs-on: ubuntu-latest
    steps:
      - name: Determine workflow to run
        run: |
          echo "Event: ${{ inputs.event_name }}"
          
          # Handle push to main
          if [ "${{ inputs.event_name }}" = "push" ]; then
            if [ "${{ inputs.ref }}" = "refs/heads/main" ]; then
              echo "Triggering on-merge-to-main.yml workflow"
              gh workflow run on-merge-to-main.yml --ref main
            else
              echo "Push to non-main branch, ignoring."
            fi

          # Handle pull requests
          elif [ "${{ inputs.event_name }}" = "pull_request" ]; then
            echo "Triggering on-pull-request.yml workflow"
            gh workflow run on-pull-request.yml --ref "${{ inputs.head_ref }}"

          # Handle issue/PR comments
          elif [ "${{ inputs.event_name }}" = "issue_comment" ]; then
            # Only consider PR comments containing "ci"
            if [[ "${{ inputs.comment_body }}" =~ ^[Cc][Ii]$ ]]; then
              echo "PR comment 'ci' detected â€” triggering on-pull-request.yml"
              # Must know the PR branch ref, passed from stub
              gh workflow run on-pull-request.yml --ref "${{ inputs.head_ref }}"
            else
              echo "Comment does not match 'ci', ignoring."
            fi

          # Handle release events
          elif [ "${{ inputs.event_name }}" = "release" ]; then
            echo "Triggering on-release.yml workflow"
            gh workflow run on-release.yml --ref "${{ inputs.ref }}"

          else
            echo "Event not handled."
