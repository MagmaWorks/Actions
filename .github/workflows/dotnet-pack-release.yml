name: Package and create draft release .NET

on:
  workflow_call:
    inputs:
      package-name:
        type: string
        required: false
        default: package
      package-dir:
        type: string
        required: false
        default: package

jobs:
  package:
    name: Draft Release
    runs-on: ubuntu-latest
    outputs:
      version-tag: ${{ steps.get_version.outputs.VERSION_TAG }}
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.package-name }}
          path: ${{ inputs.package-dir }}

      - name: Rename all packages and get version tag
        id: get_version
        shell: pwsh
        run: |
          $allPkgs = Get-ChildItem -Recurse -Include *.nupkg,*.snupkg
          if (-not $allPkgs) { throw "No packages found" }

          # Rename all files: remove -preview
          foreach ($pkg in $allPkgs) {
              $newName = $pkg.Name -replace '-preview',''
              if ($pkg.Name -ne $newName) {
                  Rename-Item $pkg.FullName $newName
              }
          }

          # Take first renamed nupkg to extract version
          $firstPkg = Get-ChildItem -Recurse -Filter "*.nupkg" | Select-Object -First 1
          if ($firstPkg.Name -match '\d+\.\d+\.\d+(\.(\d+))?') {
              $parts = $matches[0] -split '\.'
              $major = $parts[0]
              $minor = $parts[1]
              $patch = $parts[2]
              $build = if ($parts.Length -ge 4) { $parts[3] } else { 0 }
          } else {
              throw "Could not parse version from package name: $($firstPkg.Name)"
          }

          $versionTag = "$major.$minor.$patch.$build"
          echo "VERSION_TAG=$versionTag" >> $env:GITHUB_OUTPUT
          echo "Version tag: $versionTag"

      - name: Create draft release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            ./**/*.nupkg
            ./**/*.snupkg
          tag: "${{ steps.get_version.outputs.VERSION_TAG }}"
          draft: true
          allowUpdates: true
          updateOnlyUnreleased: true
