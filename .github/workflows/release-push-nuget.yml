name: Push NuGet from Release

on:
  workflow_call:
    inputs:
      private-repo:
        type: boolean
        default: false
    secrets:
      NUGET_API_KEY:
        required: true

jobs:
  Release-NuGet-Packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET Core
        if: ${{ inputs.private-repo }}        
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: ${{ vars.AZURE_ARTIFACTS_FEED_USER }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }} 

      - name: Download release assets
        run: gh release download ${{ github.event.release.tag_name }} --dir ./artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Strip build number, update nuspec, rezip, and tag git
        id: rename
        shell: pwsh
        env:
          GITHUB_PRERELEASE: ${{ github.event.release.prerelease }}
        run: |
          # -------------------------
          # Package Version Repack Script
          # -------------------------
          # Purpose:
          # - Strip build/fourth number from package versions (major.minor.patch only)
          # - Optionally append '-beta' for pre-release
          # - Update internal package dependencies
          # - Repack .nupkg/.snupkg files
          # - Git tag the canonical version and prerelease if applicable
          # -------------------------
          
          Write-Host "[Info] Searching for NuGet packages in ./artifacts..."
          $artifacts = Get-ChildItem -Path ./artifacts -File | Where-Object { $_.Extension -in '.nupkg', '.snupkg' }
          
          if (-not $artifacts -or $artifacts.Count -eq 0) {
              Write-Error "[Error] No .nupkg or .snupkg files found in ./artifacts"
              exit 1
          }
          
          # Determine prerelease suffix
          $prereleaseSuffix = if ($env:GITHUB_PRERELEASE -eq 'true') { '-beta' } else { '' }
          Write-Host "[Info] Pre-release flag: $($env:GITHUB_PRERELEASE)"
          Write-Host "[Info] Version suffix: '$prereleaseSuffix'"
          
          $newTag = $null
          
          foreach ($pkg in $artifacts) {
              Write-Host "`n[Package] Processing: $($pkg.Name)"
          
              # Match filenames like:
              #   Org.Package.Name.0.1.6.3.nupkg
              #   Org.Package.Name.1.2.3.nupkg
              #   Org.Package.Name.1.2.3-preview.4.nupkg
              #   Org.Package.Name.1.2.3-beta.nupkg
              if ($pkg.Name -notmatch '^(?<prefix>.+?)\.(?<fullVersion>\d+\.\d+\.\d+(?:\.\d+)?(?:-[^.]*)?)\.(?<ext>snupkg|nupkg)$') {
                  Write-Warning "[Warning] Skipping file (pattern mismatch): $($pkg.Name)"
                  continue
              }
          
              $pkgPrefix    = $matches['prefix']
              $fullVersion  = $matches['fullVersion']
              $pkgExtension = ".$($matches['ext'])"
          
              # Extract major.minor.patch (strip build number and prerelease suffix)
              if ($fullVersion -match '^(?<major>\d+)\.(?<minor>\d+)\.(?<patch>\d+)') {
                  $baseVersion = "$($matches['major']).$($matches['minor']).$($matches['patch'])"
              } else {
                  Write-Warning "[Warning] Could not extract base version from $fullVersion"
                  continue
              }
          
              # Compose new version with optional prerelease suffix
              $newVersion   = "$baseVersion$prereleaseSuffix"
              $pkgId        = $pkgPrefix.TrimEnd('.')
              $newFileName  = "$pkgId.$newVersion$pkgExtension"
              $destPath     = Join-Path $pkg.DirectoryName $newFileName
          
              if (-not $newTag) { $newTag = $newVersion }
          
              Write-Host "[Package] ID: $pkgId"
              Write-Host "[Package] New version: $newVersion"
              Write-Host "[Package] Output filename: $newFileName"
          
              # -------------------------
              # Expand package
              # -------------------------
              $workDir = Join-Path $pkg.DirectoryName ("work_" + [System.Guid]::NewGuid().ToString("N"))
              if (Test-Path $workDir) { Remove-Item $workDir -Recurse -Force }
              New-Item -ItemType Directory -Path $workDir | Out-Null
          
              Write-Host "[Package] Expanding package to temporary folder..."
              Expand-Archive -Path $pkg.FullName -DestinationPath $workDir -Force
          
              $nuspecFile = Get-ChildItem $workDir -Filter *.nuspec | Select-Object -First 1
              if (-not $nuspecFile) {
                  Write-Warning "[Warning] No nuspec found in $($pkg.Name). Skipping."
                  Remove-Item $workDir -Recurse -Force
                  continue
              }
          
              # -------------------------
              # Update package version
              # -------------------------
              [xml]$nuspecXml = Get-Content $nuspecFile.FullName
              $oldVersion = $nuspecXml.package.metadata.version
              $nuspecXml.package.metadata.version = $newVersion
              Write-Host "[Package] Updated version: $oldVersion -> $newVersion"
              $nuspecXml.Save($nuspecFile.FullName)
          
              # -------------------------
              # Repack package
              # -------------------------
              if (Test-Path $destPath) { Remove-Item $destPath -Force }
              Compress-Archive -Path (Join-Path $workDir '*') -DestinationPath $destPath -Force
          
              # Cleanup
              Remove-Item $pkg.FullName -Force
              Remove-Item $workDir -Recurse -Force
          
              Write-Host "[Package] Repacked: $newFileName"
          
              # -------------------------
              # Update dependencies in other packages
              # -------------------------
              $otherPackages = Get-ChildItem -Path ./artifacts -File | Where-Object { $_.Extension -in '.nupkg', '.snupkg' }
          
              foreach ($other in $otherPackages) {
                  if ($other.Name -eq $newFileName) { continue }
          
                  Write-Host "[Dependency] Checking dependencies in $($other.Name)..."
          
                  $otherWorkDir = Join-Path $other.DirectoryName ("work_" + [System.Guid]::NewGuid().ToString("N"))
                  if (Test-Path $otherWorkDir) { Remove-Item $otherWorkDir -Recurse -Force }
                  New-Item -ItemType Directory -Path $otherWorkDir | Out-Null
          
                  Expand-Archive -Path $other.FullName -DestinationPath $otherWorkDir -Force
                  $otherNuspec = Get-ChildItem $otherWorkDir -Filter *.nuspec | Select-Object -First 1
          
                  if (-not $otherNuspec) {
                      Compress-Archive -Path (Join-Path $otherWorkDir '*') -DestinationPath $other.FullName -Force
                      Remove-Item $otherWorkDir -Recurse -Force
                      continue
                  }
          
                  [xml]$otherXml = Get-Content $otherNuspec.FullName
                  $changed = $false
          
                  if ($otherXml.package.metadata.dependencies -ne $null) {
                      # Handle grouped dependencies
                      $groups = @()
                      try { $groups = @($otherXml.package.metadata.dependencies.group) } catch {}
                      foreach ($group in $groups) {
                          foreach ($dep in @($group.dependency)) {
                              if ($null -eq $dep -or -not $dep.id) { continue }
                              if ($dep.id -eq $pkgId) {
                                  $dep.version = $newVersion
                                  $changed = $true
                                  Write-Host "[Dependency] Updated group dependency ($($group.targetFramework)): $($dep.id)"
                              }
                          }
                      }
          
                      # Handle top-level dependencies
                      $topDeps = @()
                      try { $topDeps = @($otherXml.package.metadata.dependencies.dependency) } catch {}
                      foreach ($dep in $topDeps) {
                          if ($null -eq $dep -or -not $dep.id) { continue }
                          if ($dep.id -eq $pkgId) {
                              $dep.version = $newVersion
                              $changed = $true
                              Write-Host "[Dependency] Updated top-level dependency: $($dep.id)"
                          }
                      }
                  }
          
                  if ($changed) { $otherXml.Save($otherNuspec.FullName) }
          
                  # Repack other package
                  if (Test-Path $other.FullName) { Remove-Item $other.FullName -Force }
                  Compress-Archive -Path (Join-Path $otherWorkDir '*') -DestinationPath $other.FullName -Force
                  Remove-Item $otherWorkDir -Recurse -Force
              }
          }
          
          if (-not $newTag) {
              Write-Error "[Error] Could not determine version tag"
              exit 1
          }
          
          # -------------------------
          # Output version for GitHub Actions
          # -------------------------
          "VERSION_TAG=$newTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "[Info] All packages repacked successfully."
          Write-Host "[Info] Version tag: $newTag"
          
          # -------------------------
          # Git tagging
          # -------------------------
          Write-Host "[Git] Tagging commit with $newTag..."
          git tag $newTag
          
          if ($prereleaseSuffix -ne '') {
              if ($newTag -match '^(?<baseVersion>\d+\.\d+\.\d+)') {
                  $baseTag = $matches['baseVersion']
                  Write-Host "[Git] Also tagging base version: $baseTag"
                  git tag $baseTag
              }
          }
          
          git push origin --tags
          Write-Host "[Git] Tags pushed successfully."

      - name: Push to NuGet.org
        if: ${{ !inputs.private-repo }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
          --source https://api.nuget.org/v3/index.json \
          --api-key ${{ secrets.NUGET_API_KEY }}

      - name: Push to Azure
        if: ${{ inputs.private-repo }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
          --source source ${{ vars.AZURE_ARTIFACTS_FEED_URL }} \
          --api-key AzureDevOps

      - name: Update release with renamed packages
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ github.event.release.tag_name }}"
          artifacts: "./artifacts/*.*"
          draft: false
          makeLatest: true
          allowUpdates: true
          removeArtifacts: true
          updateOnlyUnreleased: false
          generateReleaseNotes: true
          name: "${{ steps.rename.outputs.VERSION_TAG }}"

      - name: Delete previous draft releases
        uses: hugo19941994/delete-draft-releases@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
