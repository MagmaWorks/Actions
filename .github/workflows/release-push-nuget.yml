name: Push NuGet from Release

on:
  workflow_call:
    inputs:
      private-repo:
        type: boolean
        default: false
    secrets:
      NUGET_API_KEY:
        required: true

jobs:
  Release-NuGet-Packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET Core
        if: ${{ inputs.private-repo }}        
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          source-url: ${{ vars.AZURE_ARTIFACTS_FEED_USER }}
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }} 

      - name: Download release assets
        run: gh release download ${{ github.event.release.tag_name }} --dir ./artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Strip build number, update nuspec, rezip, and tag git
        id: rename
        shell: pwsh
        env:
          GITHUB_PRERELEASE: ${{ github.event.release.prerelease }}
        run: |
          Write-Host "Searching for NuGet packages in ./artifacts..."
          $artifacts = Get-ChildItem -Path ./artifacts -File | Where-Object { $_.Name -match '\.(s|)nupkg$' }
          
          if (-not $artifacts) {
              Write-Error "No .nupkg or .snupkg files found in ./artifacts"
              exit 1
          }
          
          $suffix = if ($env:GITHUB_PRERELEASE -eq 'true') { '-beta' } else { '' }
          $newTag = $null
          
          Write-Host "Pre-release flag: $($env:GITHUB_PRERELEASE)"
          Write-Host "Version suffix: '$suffix'"
          
          foreach ($pkg in $artifacts) {
              Write-Host "`n--- Processing: $($pkg.Name) ---"
          
              # Extract clean version (ignore any -beta.1, .0 etc.)
              if ($pkg.Name -notmatch '^(.*?)(\d+\.\d+\.\d+)(?:-[A-Za-z0-9\.]+)?(\..*)$') {
                  Write-Warning "Skipping file (pattern mismatch): $($pkg.Name)"
                  continue
              }
          
              $prefix = $matches[1]                    # e.g. VividOrange.Geometry.
              $majorMinorPatch = $matches[2]           # e.g. 0.1.4
              $ext = $matches[3]                       # .nupkg / .snupkg
              if (-not $newTag) { $newTag = "$majorMinorPatch$suffix" }
          
              $pkgName = $prefix.TrimEnd('.')
              $newVersion = "$majorMinorPatch$suffix"
          
              Write-Host "Package id: $pkgName"
              Write-Host "New version for this package: $newVersion"
          
              $work = Join-Path $pkg.DirectoryName ([IO.Path]::GetFileNameWithoutExtension($pkg.Name))
              if (Test-Path $work) { Remove-Item $work -Recurse -Force }
              New-Item -ItemType Directory -Path $work | Out-Null
          
              Expand-Archive -Path $pkg.FullName -DestinationPath $work -Force
              Remove-Item $pkg.FullName -Force
          
              $nuspec = Get-ChildItem $work -Filter *.nuspec | Select-Object -First 1
              if (-not $nuspec) {
                  Write-Warning "No nuspec file found inside $($pkg.Name). Cleaning up and skipping."
                  Remove-Item $work -Recurse -Force
                  continue
              }
          
              [xml]$xml = Get-Content $nuspec.FullName
              $oldVersion = $xml.package.metadata.version
              $xml.package.metadata.version = $newVersion
              Write-Host "Updated own version: $oldVersion -> $newVersion"
              $xml.Save($nuspec.FullName)
          
              $outName = "$prefix$majorMinorPatch$suffix$ext"
              $dest = Join-Path $pkg.DirectoryName $outName
              if (Test-Path $dest) { Remove-Item $dest -Force }
              Compress-Archive -Path (Join-Path $work '*') -DestinationPath $dest -Force
              Remove-Item $work -Recurse -Force
              Write-Host "Repacked: $outName"
          
              # ------------------------------------------------------------
              # Update dependencies in all other packages that reference $pkgName
              # ------------------------------------------------------------
              foreach ($otherPkg in Get-ChildItem -Path ./artifacts -Filter *.nupkg -File) {
                  if ($otherPkg.Name -eq $outName) { continue }
          
                  Write-Host "  Checking other package: $($otherPkg.Name) for dependency on $pkgName"
          
                  $otherWork = Join-Path $otherPkg.DirectoryName ([IO.Path]::GetFileNameWithoutExtension($otherPkg.Name))
                  if (Test-Path $otherWork) { Remove-Item $otherWork -Recurse -Force }
                  New-Item -ItemType Directory -Path $otherWork | Out-Null
          
                  Expand-Archive -Path $otherPkg.FullName -DestinationPath $otherWork -Force
                  Remove-Item $otherPkg.FullName -Force
          
                  $otherNuspec = Get-ChildItem $otherWork -Filter *.nuspec | Select-Object -First 1
                  if (-not $otherNuspec) {
                      Write-Host "    No nuspec in $($otherPkg.Name); repacking unchanged."
                      Compress-Archive -Path (Join-Path $otherWork '*') -DestinationPath $otherPkg.FullName -Force
                      Remove-Item $otherWork -Recurse -Force
                      continue
                  }
          
                  [xml]$oXml = Get-Content $otherNuspec.FullName
                  $changed = $false
          
                  if ($oXml.package.metadata.dependencies -ne $null) {
                      # --- ✅ NEW: handle per-framework groups ---
                      foreach ($group in $oXml.package.metadata.dependencies.group) {
                          foreach ($dep in $group.dependency) {
                              if ($dep.id -eq $pkgName) {
                                  Write-Host "    Updated dependency ($($group.targetFramework)) in $($otherPkg.Name): $($dep.id) $($dep.version) -> $newVersion"
                                  $dep.version = $newVersion
                                  $changed = $true
                              }
                          }
                      }
          
                      # --- ✅ still handle top-level deps (rare but possible) ---
                      foreach ($dep in $oXml.package.metadata.dependencies.dependency) {
                          if ($dep.id -eq $pkgName) {
                              Write-Host "    Updated top-level dependency in $($otherPkg.Name): $($dep.id) $($dep.version) -> $newVersion"
                              $dep.version = $newVersion
                              $changed = $true
                          }
                      }
                  }
          
                  if ($changed) { $oXml.Save($otherNuspec.FullName) }
          
                  Compress-Archive -Path (Join-Path $otherWork '*') -DestinationPath $otherPkg.FullName -Force
                  Remove-Item $otherWork -Recurse -Force
              }
          }
          
          if (-not $newTag) {
              Write-Error "Could not determine version tag"
              exit 1
          }
          
          "VERSION_TAG=$newTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          Write-Host "`nAll packages repacked successfully."
          Write-Host "Version tag: $newTag"
          
          # Git tagging (always both base + prerelease)
          Write-Host "Tagging commit with $newTag and base version"
          git tag $newTag
          if ($newTag -match '^(?<base>\d+\.\d+\.\d+)-') {
              $baseTag = $matches['base']
              Write-Host "Also tagging base version: $baseTag"
              git tag $baseTag
          }
          git push origin --tags

      - name: Push to NuGet.org
        if: ${{ !inputs.private-repo }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
          --source https://api.nuget.org/v3/index.json \
          --api-key ${{ secrets.NUGET_API_KEY }}

      - name: Push to Azure
        if: ${{ inputs.private-repo }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
          --source source ${{ vars.AZURE_ARTIFACTS_FEED_URL }} \
          --api-key AzureDevOps

      - name: Update release with renamed packages
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.rename.outputs.VERSION_TAG }}"
          artifacts: "./artifacts/*.*"
          draft: false
          makeLatest: ${{ !github.event.release.prerelease }}
          allowUpdates: true
          removeArtifacts: true
          updateOnlyUnreleased: false
          generateReleaseNotes: true
          name: "${{ steps.rename.outputs.VERSION_TAG }}"

      - name: Delete previous draft releases
        uses: hugo19941994/delete-draft-releases@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
